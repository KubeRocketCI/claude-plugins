# Component File Anatomy

Detailed reference for the file structure of a KubeRocketCI GitLab CI/CD component library, based on the `ci-template` golden reference.

## Directory Layout

```text
ci-<language>/
├── templates/
│   ├── common.yml          # Shared hidden job templates
│   ├── review.yml          # MR pipeline component (4 stages, 10 jobs)
│   └── build.yml           # Main branch pipeline component (5 stages, 12 jobs)
├── deploy-templates/       # Helm chart (optional)
│   ├── Chart.yaml          # Helm chart metadata
│   ├── README.md           # Generated by helm-docs
│   ├── README.md.gotmpl    # Template for helm-docs
│   ├── templates/
│   │   └── .gitkeep        # Placeholder
│   └── values.yaml         # Kubernetes deployment values (80+ keys)
├── .gitlab-ci.yml          # Root orchestrator + create-release job
├── Dockerfile              # Packaging-only (no build steps inside)
├── sonar-project.properties # SonarQube config for the language
├── README.md               # Documentation with usage examples + inputs table
├── LICENSE.md               # MIT License, Copyright KubeRocketCI
├── .gitignore              # IDE, build artifacts, dependencies, cache
└── .prettierrc             # YAML formatting (singleQuote, quoteProps)
```

## templates/common.yml

Defines shared hidden job templates that review.yml and build.yml extend.

**Spec Inputs** (6):

| Input | Default | Description |
|-------|---------|-------------|
| `stage_prepare` | `'prepare'` | Preparation stage name |
| `stage_test` | `'test'` | Test stage name |
| `stage_build` | `'build'` | Build stage name |
| `codebase_name` | `'my-application'` | Project name for CI/CD operations |
| `container_image` | `'alpine:latest'` | Container image for build/test jobs |
| `chart_dir` | `'deploy-templates'` | Helm chart directory |

**Hidden Job Templates** (11):

| Template | Stage | Purpose |
|----------|-------|---------|
| `.common-variables` | — | Sets `CODEBASE_NAME` and `CHART_DIR` from inputs |
| `.dependency-cache` | — | Generic cache with `CACHE_DIR`, key from lock file |
| `.test-job` | test | Test execution, produces coverage artifacts |
| `.build-job` | build | Build execution, produces dist/ artifacts |
| `.lint-job` | test | Linting (parallel with test) |
| `.type-check-job` | test | Type checking (parallel with test) |
| `.sonar-base` | build | SonarQube scanner (image: `sonarsource/sonar-scanner-cli:11.4`) |
| `.helm-docs-job` | test | Helm docs generation (image: `jnorwood/helm-docs:v1.14.2`) |
| `.helm-lint-job` | test | Helm lint + template (image: `alpine/helm:3.19`) |
| `.dockerfile-lint-job` | test | Hadolint validation (image: `hadolint/hadolint:v2.14.0-alpine`) |
| `.buildkit-base` | — | Docker BuildKit base (image: `moby/buildkit:rootless`) |

**Extension Points** (`# IMPLEMENT:` comments):

- `.dependency-cache`: Cache key file path, cache paths
- `.test-job` script: Test command for the language
- `.build-job` script: Build command for the language
- `.lint-job` script: Lint command for the language

## templates/review.yml

MR pipeline component with 4 stages and 10 jobs.

**Additional Spec Inputs** (beyond common): `stage_verify`

**Include**: `local: 'templates/common.yml'` with input passthrough

**Stages**: `[prepare, test, build, verify]`

**Jobs**:

| Job | Stage | Extends | Needs | Purpose |
|-----|-------|---------|-------|---------|
| `init-values` | prepare | — | — | Produces `branch.env` dotenv |
| `test` | test | `.test-job` | `[]` | Runs tests, produces coverage |
| `build` | build | `.build-job` | `[test]` | Builds application |
| `lint` | test | `.lint-job` | `[]` | Linting (parallel) |
| `type-check` | test | `.type-check-job` | `[]` | Type checking (parallel) |
| `helm-docs` | test | `.helm-docs-job` | `[]` | Helm docs (parallel) |
| `helm-lint` | test | `.helm-lint-job` | `[]` | Helm lint (parallel) |
| `sonar` | build | `.sonar-base` | `[init-values, test]` | PR SonarQube analysis |
| `dockerfile-lint` | test | `.dockerfile-lint-job` | `[]` | Dockerfile validation |
| `dockerbuild-verify` | verify | `.buildkit-base` | `[init-values, build, sonar, dockerfile-lint]` | Verify Docker build (push=false) |

**init-values output** (`branch.env`):

```bash
BRANCH_NAME=${CI_COMMIT_REF_NAME}
PROJECT_NAME=${CODEBASE_NAME}
MR_IID=${CI_MERGE_REQUEST_IID}
SOURCE_BRANCH=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
TARGET_BRANCH=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}
```

## templates/build.yml

Main branch pipeline component with 5 stages and 12 jobs.

**Additional Spec Inputs** (beyond common): `stage_package`, `stage_publish`, `image_registry`

**Include**: `local: 'templates/common.yml'` with input passthrough

**Stages**: `[prepare, test, build, package, publish]`

**Jobs** (in addition to review jobs):

| Job | Stage | Extends | Needs | Purpose |
|-----|-------|---------|-------|---------|
| `init-values` | prepare | — | — | Produces `build.env` dotenv |
| `buildkit-build` | package | `.buildkit-base` | `[init-values, build, sonar]` | Build + push container image |
| `package-publish` | package | `.dependency-cache` | `[init-values, build]` | Optional artifact publishing |
| `git-tag` | publish | — | `[buildkit-build, init-values]` | Create + push annotated git tag |

**init-values output** (`build.env`):

```bash
BRANCH_NAME=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-${CI_COMMIT_REF_NAME}}
PROJECT_NAME=${CODEBASE_NAME}
BUILD_VERSION=${CI_COMMIT_SHORT_SHA}
BUILD_NUMBER=${CI_PIPELINE_ID}
BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
VCS_TAG=${CI_COMMIT_TAG:-v0.1.0-${CI_COMMIT_SHORT_SHA}}
IMAGE_TAG=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
```

**Note**: `BUILD_VERSION`, `VCS_TAG`, and `IMAGE_TAG` use `CI_COMMIT_SHORT_SHA` as defaults. Tech-specific version extraction (from `pom.xml`, `package.json`, `pyproject.toml`, etc.) should replace these via `# IMPLEMENT:` extension points.

## .gitlab-ci.yml (Root Orchestrator)

**Workflow rules** — Pipeline triggers only for:

- MR events (`$CI_PIPELINE_SOURCE == "merge_request_event"`)
- Protected branches (`$CI_COMMIT_REF_PROTECTED == "true"`)
- Semver tags (`$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/`)

**Global variables**: `CODEBASE_NAME`, `CONTAINER_IMAGE`, `IMAGE_REGISTRY`, `SONAR_ORG`, `CHART_DIR`

**Component inclusion**: Review component for MR events, build component for protected branches. Both reference `@$CI_COMMIT_SHA` for local testing.

**Additional jobs**:

- `visible-job-lint-fix` — Stage `.pre`, `when: never` (GitLab UI visibility only)
- `create-release` — Stage `release`, triggers on semver tags, creates GitLab release

## Dockerfile

Follows **packaging-only** philosophy — no compilation or build steps inside Docker:

```dockerfile
FROM <runtime-base-image>
WORKDIR /app
COPY <pre-built-artifacts> .
EXPOSE 8080
```

The CI pipeline handles all compilation. Dockerfile only packages the result.

## sonar-project.properties

Language-specific SonarQube configuration:

- `sonar.projectKey=kuberocketci_ci-<language>`
- `sonar.organization=kuberocketci`
- `sonar.sources=.`
- Language-specific exclusions (test files, build artifacts, dependencies)
- Coverage report paths (format depends on language)

## README.md Structure

README must contain:

1. **Overview** — What the component does, key features
2. **Quick Start** — 6-step guide (clone, configure, implement, variables, test, publish)
3. **Components** — Description of common.yml, review.yml, build.yml
4. **Inputs Table** — All inputs with name, description, default
5. **Implementation Guide** — Tech-specific examples
6. **Workflow Diagrams** — Mermaid diagrams for MR and main branch flows
7. **Usage Examples** — Consumer `include:component` snippets
8. **Security Best Practices** — For maintainers and consumers

## Helm Chart (deploy-templates/)

Use `helm create` to generate a basic chart structure, then customize:

Optional Kubernetes deployment chart:

- **Chart.yaml**: apiVersion v2, type application, version 0.1.0
- **values.yaml**: 80+ configurable keys (image, service, ingress, resources, health checks, security, autoscaling, PDB, persistence, monitoring)
- **README.md**: Auto-generated by helm-docs from README.md.gotmpl

## Configuration Files

**.gitignore**: IDE files, build artifacts, dependency directories, cache, .env files, OS-specific files.

**.prettierrc**: `singleQuote: true`, `quoteProps: "consistent"`, YAML overrides for templates.

**LICENSE.md**: MIT License, Copyright KubeRocketCI.
